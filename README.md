# handel-qsp-probenecid-dosing

## 1) Project purpose
This repository contains a quantitative systems pharmacology (QSP) modeling
workflow for evaluating probenecid dosing in an H5N1 mouse infection study.
Two related ODE models are fit to experimental data (log viral load, IL-6,
and percent weight loss) across multiple treatment conditions. The fitted
models are then used to simulate dose-response trajectories, generate figures
and tables for the manuscript, and support an interactive exploration app.

## 2) Folder structure
Top-level folders are organized by role:

- `assets/`: static assets (figures, bibliography, style files).
- `code/`: all code, organized by subfolders:
  - `analysis-code/`: model fitting, simulation, and interactive app.
  - `plotting-code/`: figure and table generation.
  - `processing-code/`: raw data cleaning and processing.
- `data/`: raw and processed datasets.
- `products/`: manuscript and supplementary materials.
- `results/`: outputs generated by code (fits, figures, tables).

## 3) Analysis approach and pipeline

### 3.1 Theoretical approach
The models are fit to time-series measurements of log viral load, IL-6, and
percent weight loss under three treatment conditions. A maximum likelihood
objective is used with additive errors and per-variable variances (details are
documented in the manuscript). The objective aggregates contributions across
variables and doses, with inverse-sample-size weighting.

### 3.2 Code-level pipeline
The pipeline is intentionally staged:

1) **Process raw data** (optional):
   - `code/processing-code/processingcode.R`
   - Produces `data/processed-data/processeddata.csv`.

2) **Fit model parameters** (always multistart, optional sampling):
   - `code/analysis-code/run-fit.R`
   - Stage 1 (always): multistart global search + refinement.
   - Stage 2 (optional): re-fit across fixed-parameter samples using the
     multistart bestfit as the starting point for every sample.
   - Outputs:
     - `results/output/<model>-bestfit-multistart.Rds`
     - `results/output/<model>-bestfit-sample.Rds` (if sampling stage enabled)

3) **Simulate dose-response trajectories**:
   - `code/analysis-code/run-dose-predictions.R`
   - Uses `*-bestfit-sample.Rds` to simulate multiple dosing scenarios.
   - Output:
     - `results/output/<model>-dose-response-results.Rds`

4) **Generate figures and tables**:
   - `code/plotting-code/run-plotting.R`
   - Reads `*-bestfit-sample.Rds` and `*-dose-response-results.Rds`.
   - Writes figures to `results/figures/` and tables to `results/tables/`.

5) **Interactive exploration (optional)**:
   - `code/analysis-code/app.R`
   - Shiny app for exploring fitted parameters and simulated trajectories.

## 4) Major code files and what they do

### Analysis code (entry points)
- `code/analysis-code/run-fit.R`
  - Main fitting script. Always runs multistart and saves
    `*-bestfit-multistart.Rds`.
  - Optionally runs fixed-parameter sampling (single-fit per sample) using
    the multistart bestfit as the starting point for every sample.
- `code/analysis-code/run-dose-predictions.R`
  - Simulates dose-response trajectories and summary statistics from
    `*-bestfit-sample.Rds`.
- `code/analysis-code/app.R`
  - Shiny application to visualize fits and objective contributions.

### Analysis code (functions)
Located in `code/analysis-code/functions/`:
- `model1-simulator-function.R`, `model2-simulator-function.R`:
  ODE simulators for the two model variants.
- `fit-function.R`:
  Objective function wrapper and per-variable weighting logic.
- `fit-single-function.R`:
  Single-run optimizer wrapper (used by sampling stage).
- `fit-data-function.R`:
  Loads and standardizes processed data for fitting.
- `model-config-function.R`:
  Central configuration for model-specific parameters and bounds.
- `fixed-parameters-function.R`:
  Loads fixed-parameter CSV files.
- `fixed-parameter-sampling-function.R`:
  Generates fixed-parameter samples (baseline + LHS samples).
- `sigma-settings-function.R`:
  Defines which error terms are fixed vs. fitted.
- `bestfit-pack-function.R`:
  Standardizes optimizer output into the projectâ€™s bestfit structure.
- `dose-predictions-function.R`:
  Runs post-fit dose simulations and aggregates outputs.

### Plotting code
- `code/plotting-code/run-plotting.R`
  - One script to generate all plots/tables with toggles.
- `code/plotting-code/functions/`
  - `timeseries-plot-function.R`
  - `dose-response-plot-function.R`
  - `diagnostic-plot-function.R`
  - `stage1-trajectory-plot-function.R`
  - `plotting-config-function.R`

### Processing code
- `code/processing-code/processingcode.R`
  - Reads raw Excel files and writes cleaned CSV to `data/processed-data/`.

## 5) How to run the full analysis

Below is the typical end-to-end workflow (from the repo root):

1) **Process raw data** (only needed if raw data changed):
   ```bash
   Rscript code/processing-code/processingcode.R
   ```

2) **Fit the model** (always runs multistart; optional sampling stage):
   - Open `code/analysis-code/run-fit.R` and set:
     - `model_choice` to `"model1"` or `"model2"`.
     - `run_sampling_stage` to `TRUE` to generate `*-bestfit-sample.Rds`.
   ```bash
   Rscript code/analysis-code/run-fit.R
   ```

3) **Simulate dose-response trajectories**:
   - Set `model_choice` in `code/analysis-code/run-dose-predictions.R`.
   ```bash
   Rscript code/analysis-code/run-dose-predictions.R
   ```

4) **Generate plots and tables**:
   - Set `model_choice` and toggles in `code/plotting-code/run-plotting.R`.
   ```bash
   Rscript code/plotting-code/run-plotting.R
   ```

5) **Launch the interactive app** (optional):
   ```bash
   Rscript code/analysis-code/app.R
   ```
   Or run the file inside RStudio to open the Shiny app.

## Notes
- Downstream analyses (dose predictions, plotting, app) read
  `*-bestfit-sample.Rds` only.
- `*-bestfit-multistart.Rds` is used exclusively by `run-fit.R` as a source
  of starting values for additional fitting.
